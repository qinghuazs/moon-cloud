# 用户认证接口文档

## 概述

本文档描述了 Moon Cloud 用户管理系统的用户认证相关接口，包括用户注册、登录、Google OAuth 登录、令牌管理等功能。

### 基础信息

- **API 版本**: v1.0
- **基础路径**: `/api/user/api/auth`
- **Content-Type**: `application/json`
- **字符编码**: `UTF-8`

### 认证方式

除了公开接口外，其他接口需要在请求头中携带 JWT 令牌：
```
Authorization: Bearer <access_token>
```

---

## 1. 用户注册

### 接口信息
- **接口名称**: 用户注册
- **请求方法**: `POST`
- **接口路径**: `/register`
- **接口描述**: 新用户注册并自动登录返回 JWT 令牌

### 请求参数

#### Headers
```
Content-Type: application/json
```

#### Body Parameters
| 参数名 | 类型 | 必填 | 长度限制 | 说明 | 示例 |
|--------|------|------|----------|------|------|
| username | string | 是 | 3-50字符 | 用户名，唯一 | "moonuser" |
| email | string | 是 | - | 邮箱地址，唯一 | "user@example.com" |
| password | string | 是 | 8-100字符 | 密码 | "password123" |
| nickname | string | 否 | - | 昵称 | "Moon User" |
| phone | string | 否 | - | 手机号 | "13800138000" |

#### 请求示例
```json
{
  "username": "moonuser",
  "email": "user@example.com",
  "password": "password123",
  "nickname": "Moon User",
  "phone": "13800138000"
}
```

### 响应参数

#### 成功响应 (200)
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "accessToken": "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9..."
  }
}
```

#### 错误响应
```json
{
  "code": 400,
  "message": "用户名已存在",
  "data": null
}
```

### 错误码说明
| 错误码 | 说明 |
|--------|------|
| 400 | 用户名已存在 |
| 400 | 邮箱已被注册 |
| 400 | 手机号已被注册 |
| 400 | 参数验证失败 |

---

## 2. 用户登录

### 接口信息
- **接口名称**: 用户登录
- **请求方法**: `POST`
- **接口路径**: `/login`
- **接口描述**: 用户使用用户名和密码登录获取 JWT 令牌

### 请求参数

#### Headers
```
Content-Type: application/json
```

#### Body Parameters
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| username | string | 是 | 用户名或邮箱 | "moonuser" |
| password | string | 是 | 密码 | "password123" |

#### 请求示例
```json
{
  "username": "moonuser",
  "password": "password123"
}
```

### 响应参数

#### 成功响应 (200)
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "accessToken": "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9..."
  }
}
```

#### 错误响应
```json
{
  "code": 400,
  "message": "用户名或密码错误",
  "data": null
}
```

### 错误码说明
| 错误码 | 说明 |
|--------|------|
| 400 | 用户名或密码错误 |
| 400 | 用户已被禁用 |
| 400 | 登录失败次数过多，IP已被锁定 |

### 安全特性
- 连续登录失败 5 次将锁定 IP 地址 30 分钟
- 密码使用 BCrypt 加密验证
- 记录登录日志（IP、用户代理等）

---

## 3. Google OAuth 登录

### 接口信息
- **接口名称**: Google OAuth 登录
- **请求方法**: `POST`
- **接口路径**: `/login/google`
- **接口描述**: 使用 Google ID Token 进行登录，新用户自动注册

### 请求参数

#### Headers
```
Content-Type: application/json
```

#### Body Parameters
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| idToken | string | 是 | Google ID Token | "eyJhbGciOiJSUzI1NiIsImtpZCI6..." |

#### 请求示例
```json
{
  "idToken": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjE2NzAyNGF..."
}
```

### 响应参数

#### 成功响应 (200)
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "accessToken": "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9..."
  }
}
```

#### 错误响应
```json
{
  "code": 400,
  "message": "Google ID Token验证失败",
  "data": null
}
```

### 错误码说明
| 错误码 | 说明 |
|--------|------|
| 400 | Google ID Token验证失败 |
| 400 | 用户已被禁用 |

### 业务逻辑
1. 验证 Google ID Token 的有效性
2. 提取用户信息（Google ID、邮箱、昵称、头像等）
3. 如果是新用户，自动创建账号并关联 Google 账号
4. 如果是已有用户，更新用户信息
5. 返回 JWT 令牌

---

## 4. 刷新令牌

### 接口信息
- **接口名称**: 刷新令牌
- **请求方法**: `POST`
- **接口路径**: `/refresh`
- **接口描述**: 使用刷新令牌获取新的访问令牌和刷新令牌

### 请求参数

#### Headers
```
Content-Type: application/json
```

#### Body Parameters
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| refreshToken | string | 是 | 刷新令牌 | "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9..." |

#### 请求示例
```json
{
  "refreshToken": "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9..."
}
```

### 响应参数

#### 成功响应 (200)
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "accessToken": "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9..."
  }
}
```

#### 错误响应
```json
{
  "code": 400,
  "message": "无效的刷新令牌",
  "data": null
}
```

### 错误码说明
| 错误码 | 说明 |
|--------|------|
| 400 | 无效的刷新令牌 |
| 400 | 刷新令牌已被使用或已失效 |
| 400 | 用户不存在或已被禁用 |

### 安全特性
- 旧的刷新令牌在使用后立即失效
- 刷新令牌有效期为 7 天
- 刷新令牌一次性使用，防止重放攻击

---

## 5. 用户登出

### 接口信息
- **接口名称**: 用户登出
- **请求方法**: `POST`
- **接口路径**: `/logout`
- **接口描述**: 用户登出，将当前令牌加入黑名单

### 请求参数

#### Headers
```
Authorization: Bearer <access_token>
```

#### 请求示例
```bash
curl -X POST \
  http://localhost:8080/api/user/api/auth/logout \
  -H 'Authorization: Bearer eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9...'
```

### 响应参数

#### 成功响应 (200)
```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

### 业务逻辑
1. 提取请求头中的 JWT 令牌
2. 获取令牌的剩余有效时间
3. 将令牌的 JTI 加入黑名单
4. 清除用户缓存信息

---

## 6. 验证令牌

### 接口信息
- **接口名称**: 验证令牌
- **请求方法**: `POST`
- **接口路径**: `/validate`
- **接口描述**: 验证访问令牌是否有效

### 请求参数

#### Headers
```
Authorization: Bearer <access_token>
```

#### 请求示例
```bash
curl -X POST \
  http://localhost:8080/api/user/api/auth/validate \
  -H 'Authorization: Bearer eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9...'
```

### 响应参数

#### 成功响应 (200)
```json
{
  "code": 200,
  "message": "success",
  "data": true
}
```

#### 令牌无效响应 (200)
```json
{
  "code": 200,
  "message": "success",
  "data": false
}
```

### 验证规则
- 令牌格式正确
- 令牌未过期
- 令牌未在黑名单中
- 令牌签名有效

---

## 7. 获取当前用户信息

### 接口信息
- **接口名称**: 获取当前用户信息
- **请求方法**: `GET`
- **接口路径**: `/me`
- **接口描述**: 根据令牌获取当前登录用户的详细信息

### 请求参数

#### Headers
```
Authorization: Bearer <access_token>
```

#### 请求示例
```bash
curl -X GET \
  http://localhost:8080/api/user/api/auth/me \
  -H 'Authorization: Bearer eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9...'
```

### 响应参数

#### 成功响应 (200)
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "moonuser",
    "email": "user@example.com",
    "nickname": "Moon User",
    "avatarUrl": "https://lh3.googleusercontent.com/a/...",
    "phone": "13800138000",
    "status": 1,
    "googleId": "123456789",
    "providerType": "GOOGLE",
    "isEmailVerified": true,
    "lastLoginAt": "2024-01-01T12:00:00",
    "createdAt": "2024-01-01T00:00:00",
    "updatedAt": "2024-01-01T12:00:00",
    "roles": [
      {
        "id": 3,
        "roleName": "普通用户",
        "roleCode": "USER",
        "description": "普通用户，拥有基本功能权限"
      }
    ]
  }
}
```

#### 错误响应
```json
{
  "code": 400,
  "message": "无效的访问令牌",
  "data": null
}
```

### 响应字段说明
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | number | 用户 ID |
| username | string | 用户名 |
| email | string | 邮箱 |
| nickname | string | 昵称 |
| avatarUrl | string | 头像 URL |
| phone | string | 手机号 |
| status | number | 状态：0-禁用，1-启用 |
| googleId | string | Google 用户 ID |
| providerType | string | 登录方式：LOCAL-本地，GOOGLE-谷歌 |
| isEmailVerified | boolean | 邮箱是否已验证 |
| lastLoginAt | string | 最后登录时间 |
| createdAt | string | 创建时间 |
| updatedAt | string | 更新时间 |
| roles | array | 用户角色列表 |

---

## 8. Token 保活

### 接口信息
- **接口名称**: Token 保活
- **请求方法**: `POST`
- **接口路径**: `/keepalive`
- **接口描述**: 延长当前令牌的有效期，返回新的令牌

### 请求参数

#### Headers
```
Authorization: Bearer <access_token>
```

#### 请求示例
```bash
curl -X POST \
  http://localhost:8080/api/user/api/auth/keepalive \
  -H 'Authorization: Bearer eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9...'
```

### 响应参数

#### 成功响应 (200)
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "accessToken": "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9..."
  }
}
```

#### 错误响应
```json
{
  "code": 400,
  "message": "无效的访问令牌",
  "data": null
}
```

### 业务逻辑
1. 验证当前令牌有效性
2. 获取用户信息
3. 生成新的访问令牌和刷新令牌
4. 将旧令牌加入黑名单
5. 返回新令牌

### 使用建议
- 建议在令牌过期前 10-15 分钟调用此接口
- 客户端应该保存新返回的令牌替换旧令牌

---

## 错误处理

### 统一错误响应格式
```json
{
  "code": 400,
  "message": "错误描述信息",
  "data": null
}
```

### 常见 HTTP 状态码
| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证或令牌无效 |
| 403 | 无权限访问 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

### 业务错误码
| 错误码 | 说明 |
|--------|------|
| 400 | 参数验证失败 |
| 400 | 用户名已存在 |
| 400 | 邮箱已被注册 |
| 400 | 手机号已被注册 |
| 400 | 用户名或密码错误 |
| 400 | 用户已被禁用 |
| 400 | 登录失败次数过多，IP已被锁定 |
| 400 | Google ID Token验证失败 |
| 400 | 无效的刷新令牌 |
| 400 | 刷新令牌已被使用或已失效 |
| 400 | 无效的访问令牌 |

---

## 前端集成指南

### 1. 用户注册/登录流程

```javascript
// 用户注册
async function register(userData) {
  try {
    const response = await fetch('/api/user/api/auth/register', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(userData)
    });

    const result = await response.json();
    if (result.code === 200) {
      // 保存令牌
      localStorage.setItem('accessToken', result.data.accessToken);
      localStorage.setItem('refreshToken', result.data.refreshToken);
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('注册失败:', error);
    throw error;
  }
}

// 用户登录
async function login(username, password) {
  try {
    const response = await fetch('/api/user/api/auth/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ username, password })
    });

    const result = await response.json();
    if (result.code === 200) {
      // 保存令牌
      localStorage.setItem('accessToken', result.data.accessToken);
      localStorage.setItem('refreshToken', result.data.refreshToken);
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('登录失败:', error);
    throw error;
  }
}
```

### 2. 令牌管理

```javascript
// 获取访问令牌
function getAccessToken() {
  return localStorage.getItem('accessToken');
}

// 自动添加认证头
function createAuthHeader() {
  const token = getAccessToken();
  return token ? { 'Authorization': `Bearer ${token}` } : {};
}

// 刷新令牌
async function refreshToken() {
  const refreshToken = localStorage.getItem('refreshToken');
  if (!refreshToken) {
    throw new Error('没有刷新令牌');
  }

  try {
    const response = await fetch('/api/user/api/auth/refresh', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ refreshToken })
    });

    const result = await response.json();
    if (result.code === 200) {
      localStorage.setItem('accessToken', result.data.accessToken);
      localStorage.setItem('refreshToken', result.data.refreshToken);
      return result.data;
    } else {
      // 刷新失败，清除本地令牌
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('刷新令牌失败:', error);
    throw error;
  }
}

// 带自动刷新的请求函数
async function apiRequest(url, options = {}) {
  const headers = {
    'Content-Type': 'application/json',
    ...createAuthHeader(),
    ...options.headers
  };

  try {
    let response = await fetch(url, { ...options, headers });

    // 如果返回 401，尝试刷新令牌
    if (response.status === 401) {
      await refreshToken();
      // 重新发送请求
      headers.Authorization = `Bearer ${getAccessToken()}`;
      response = await fetch(url, { ...options, headers });
    }

    return await response.json();
  } catch (error) {
    console.error('API 请求失败:', error);
    throw error;
  }
}
```

### 3. Google OAuth 集成

```javascript
// Google 登录（需要先引入 Google API）
async function loginWithGoogle() {
  try {
    // 获取 Google ID Token（这部分需要 Google API）
    const idToken = await getGoogleIdToken();

    const response = await fetch('/api/user/api/auth/login/google', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ idToken })
    });

    const result = await response.json();
    if (result.code === 200) {
      localStorage.setItem('accessToken', result.data.accessToken);
      localStorage.setItem('refreshToken', result.data.refreshToken);
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('Google 登录失败:', error);
    throw error;
  }
}
```

### 4. 用户信息获取

```javascript
// 获取当前用户信息
async function getCurrentUser() {
  try {
    const result = await apiRequest('/api/user/api/auth/me', {
      method: 'GET'
    });

    if (result.code === 200) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取用户信息失败:', error);
    throw error;
  }
}
```

### 5. 用户登出

```javascript
// 用户登出
async function logout() {
  try {
    await apiRequest('/api/user/api/auth/logout', {
      method: 'POST'
    });
  } catch (error) {
    console.error('登出请求失败:', error);
  } finally {
    // 清除本地存储的令牌
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    // 重定向到登录页面
    window.location.href = '/login';
  }
}
```

### 6. Token 保活机制

```javascript
// 定期保活 Token
function startTokenKeepAlive() {
  // 每 20 分钟保活一次（Token 有效期 24 小时）
  setInterval(async () => {
    try {
      const result = await apiRequest('/api/user/api/auth/keepalive', {
        method: 'POST'
      });

      if (result.code === 200) {
        localStorage.setItem('accessToken', result.data.accessToken);
        localStorage.setItem('refreshToken', result.data.refreshToken);
        console.log('Token 保活成功');
      }
    } catch (error) {
      console.error('Token 保活失败:', error);
    }
  }, 20 * 60 * 1000); // 20 分钟
}

// 在用户登录后启动保活
function onUserLogin() {
  startTokenKeepAlive();
}
```

---

## 配置说明

### 环境变量配置

```bash
# Google OAuth 配置
GOOGLE_CLIENT_ID=your-google-client-id

# JWT 配置（可选，有默认值）
JWT_SECRET=moonCloudUserSecretKey2024
JWT_EXPIRATION=86400000
JWT_REFRESH_EXPIRATION=604800000

# 数据库配置
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_DATABASE=moon
MYSQL_USERNAME=your-username
MYSQL_PASSWORD=your-password

# Redis 配置
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DATABASE=0
```

### 应用配置文件 (application.yml)

```yaml
google:
  oauth:
    client-id: ${GOOGLE_CLIENT_ID:your-google-client-id}

jwt:
  secret: ${JWT_SECRET:moonCloudUserSecretKey2024}
  expiration: ${JWT_EXPIRATION:86400000}
  refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800000}

spring:
  datasource:
    url: jdbc:mysql://${MYSQL_HOST:localhost}:${MYSQL_PORT:3306}/${MYSQL_DATABASE:moon}
    username: ${MYSQL_USERNAME:root}
    password: ${MYSQL_PASSWORD:password}

  redis:
    host: ${REDIS_HOST:127.0.0.1}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    database: ${REDIS_DATABASE:0}
```

---

## 测试示例

### Postman 测试集合

#### 1. 用户注册
```
POST http://localhost:8080/api/user/api/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "email": "test@example.com",
  "password": "password123",
  "nickname": "测试用户"
}
```

#### 2. 用户登录
```
POST http://localhost:8080/api/user/api/auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}
```

#### 3. 获取用户信息
```
GET http://localhost:8080/api/user/api/auth/me
Authorization: Bearer {{accessToken}}
```

#### 4. 刷新令牌
```
POST http://localhost:8080/api/user/api/auth/refresh
Content-Type: application/json

{
  "refreshToken": "{{refreshToken}}"
}
```

#### 5. 用户登出
```
POST http://localhost:8080/api/user/api/auth/logout
Authorization: Bearer {{accessToken}}
```

---

## 附录

### JWT Token 结构

#### Access Token Payload
```json
{
  "sub": "username",
  "userId": 1,
  "type": "access",
  "iat": 1640995200,
  "exp": 1641081600,
  "jti": "uuid"
}
```

#### Refresh Token Payload
```json
{
  "sub": "username",
  "userId": 1,
  "type": "refresh",
  "iat": 1640995200,
  "exp": 1641600000
}
```

### 数据库表结构

#### sys_user 表
```sql
CREATE TABLE `sys_user` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password_hash` varchar(100) DEFAULT NULL COMMENT '密码哈希',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `avatar_url` varchar(500) DEFAULT NULL COMMENT '头像URL',
  `status` tinyint DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
  `google_id` varchar(100) DEFAULT NULL COMMENT 'Google用户ID',
  `provider_type` varchar(20) DEFAULT 'LOCAL' COMMENT '登录提供商类型：LOCAL-本地，GOOGLE-谷歌',
  `is_email_verified` tinyint(1) DEFAULT '0' COMMENT '邮箱是否已验证',
  `last_login_at` datetime DEFAULT NULL COMMENT '最后登录时间',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_email` (`email`),
  UNIQUE KEY `uk_phone` (`phone`),
  UNIQUE KEY `uk_google_id` (`google_id`),
  KEY `idx_status` (`status`),
  KEY `idx_provider_type` (`provider_type`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

---

## 更新日志

### v1.0.0 (2024-01-01)
- 初始版本发布
- 支持用户注册登录
- 支持 Google OAuth 登录
- 支持 JWT 令牌认证
- 支持令牌刷新和保活
- 支持用户信息获取
- 完整的安全机制和错误处理