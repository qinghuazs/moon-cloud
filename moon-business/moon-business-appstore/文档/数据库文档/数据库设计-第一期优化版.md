# iOS限免应用跟踪App - 数据库设计文档（第一期优化版）

## 文档信息

**文档版本**: V2.0
**创建日期**: 2024-09-26
**更新说明**: 基于第一期开发需求优化数据库设计
**适用范围**: 限免应用发现核心功能

---

## 设计概述

### 设计原则
1. **性能优先**: 针对高频查询场景进行索引优化
2. **数据完整性**: 确保限免数据的准确性和一致性
3. **扩展性**: 为后续功能扩展预留接口和字段
4. **查询效率**: 优化列表展示、搜索、筛选等核心查询

### 核心业务实体
- **应用信息** (apps): 存储App Store应用的基础信息
- **限免记录** (free_promotions): 记录应用的限免活动信息
- **价格历史** (price_history): 跟踪应用的价格变化历史
- **应用分类** (categories): App Store官方分类信息
- **搜索索引** (search_index): 支持全文搜索的索引表

---

## 核心表结构设计

### 1. 应用信息表 (apps)

**表说明**: 存储App Store应用的基础信息，支持限免列表展示和应用详情页面

```sql
CREATE TABLE `apps` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `app_id` varchar(20) NOT NULL COMMENT 'App Store应用ID',
  `bundle_id` varchar(255) DEFAULT NULL COMMENT '应用Bundle ID',

  -- 基础信息
  `name` varchar(255) NOT NULL COMMENT '应用名称',
  `subtitle` varchar(255) DEFAULT NULL COMMENT '应用副标题',
  `description` text COMMENT '应用描述',
  `developer_name` varchar(255) NOT NULL COMMENT '开发商名称',
  `developer_id` varchar(20) DEFAULT NULL COMMENT '开发商ID',
  `developer_url` varchar(500) DEFAULT NULL COMMENT '开发商网站',

  -- 分类信息
  `primary_category_id` varchar(20) NOT NULL COMMENT '主分类ID',
  `primary_category_name` varchar(100) NOT NULL COMMENT '主分类名称',
  `categories` json DEFAULT NULL COMMENT '所有分类信息(JSON)',

  -- 版本信息
  `version` varchar(50) DEFAULT NULL COMMENT '当前版本号',
  `release_date` datetime DEFAULT NULL COMMENT '首次发布时间',
  `updated_date` datetime DEFAULT NULL COMMENT '最后更新时间',
  `release_notes` text COMMENT '版本更新说明',
  `file_size` bigint DEFAULT NULL COMMENT '应用大小(字节)',
  `minimum_os_version` varchar(20) DEFAULT NULL COMMENT '最低系统要求',

  -- 媒体资源
  `icon_url` varchar(500) DEFAULT NULL COMMENT '应用图标URL',
  `screenshots` json DEFAULT NULL COMMENT '截图URLs(JSON数组)',
  `ipad_screenshots` json DEFAULT NULL COMMENT 'iPad截图URLs(JSON数组)',
  `preview_video_url` varchar(500) DEFAULT NULL COMMENT '预览视频URL',

  -- 评分信息
  `rating` decimal(3,2) DEFAULT NULL COMMENT '平均评分',
  `rating_count` int DEFAULT NULL COMMENT '评分总数',
  `current_version_rating` decimal(3,2) DEFAULT NULL COMMENT '当前版本评分',
  `current_version_rating_count` int DEFAULT NULL COMMENT '当前版本评分数',

  -- 价格信息
  `current_price` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '当前价格',
  `original_price` decimal(10,2) DEFAULT NULL COMMENT '原价(用于计算优惠)',
  `currency` varchar(10) DEFAULT 'CNY' COMMENT '货币类型',
  `is_free` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否免费应用',

  -- 应用属性
  `content_rating` varchar(20) DEFAULT NULL COMMENT '内容分级',
  `languages` json DEFAULT NULL COMMENT '支持语言(JSON数组)',
  `supported_devices` json DEFAULT NULL COMMENT '支持设备(JSON数组)',
  `features` json DEFAULT NULL COMMENT '应用特性(JSON数组)',
  `has_in_app_purchase` tinyint(1) DEFAULT '0' COMMENT '是否有内购',
  `has_ads` tinyint(1) DEFAULT NULL COMMENT '是否含广告',

  -- 系统字段
  `status` tinyint(1) NOT NULL DEFAULT '1' COMMENT '状态: 1=正常, 0=下架',
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `last_crawled_at` timestamp DEFAULT NULL COMMENT '最后爬取时间',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_app_id` (`app_id`),
  KEY `idx_category_price` (`primary_category_id`, `current_price`),
  KEY `idx_developer` (`developer_id`),
  KEY `idx_rating` (`rating`),
  KEY `idx_updated` (`updated_at`),
  KEY `idx_status_category` (`status`, `primary_category_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='应用信息表';
```

### 2. 限免推广记录表 (free_promotions)

**表说明**: 记录应用的限免活动，支持今日限免列表和历史限免查询

```sql
CREATE TABLE `free_promotions` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `app_id` varchar(32) NOT NULL COMMENT '应用ID(关联apps表)',
  `appstore_app_id` varchar(20) NOT NULL COMMENT 'App Store应用ID',

  -- 限免信息
  `promotion_type` varchar(20) NOT NULL DEFAULT 'FREE' COMMENT '推广类型: FREE=限免, DISCOUNT=打折',
  `original_price` decimal(10,2) NOT NULL COMMENT '原价',
  `promotion_price` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '推广价格',
  `discount_rate` decimal(5,2) DEFAULT NULL COMMENT '折扣率(%)',
  `savings_amount` decimal(10,2) NOT NULL COMMENT '节省金额',

  -- 时间信息
  `start_time` datetime NOT NULL COMMENT '限免开始时间',
  `end_time` datetime DEFAULT NULL COMMENT '限免结束时间(预估)',
  `actual_end_time` datetime DEFAULT NULL COMMENT '实际结束时间',
  `duration_hours` int DEFAULT NULL COMMENT '限免持续时长(小时)',

  -- 发现信息
  `discovered_at` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '发现时间',
  `discovery_source` varchar(50) DEFAULT NULL COMMENT '发现来源: AUTO=自动, USER=用户提交, EDITOR=编辑添加',
  `confirmed_at` timestamp DEFAULT NULL COMMENT '确认时间',
  `confirmed_by` varchar(100) DEFAULT NULL COMMENT '确认人员',

  -- 状态标记
  `status` varchar(20) NOT NULL DEFAULT 'ACTIVE' COMMENT '状态: ACTIVE=进行中, ENDED=已结束, INVALID=无效',
  `is_featured` tinyint(1) DEFAULT '0' COMMENT '是否编辑推荐',
  `is_hot` tinyint(1) DEFAULT '0' COMMENT '是否热门',
  `priority_score` int DEFAULT '0' COMMENT '优先级得分(用于排序)',

  -- 统计信息
  `view_count` int DEFAULT '0' COMMENT '查看次数',
  `click_count` int DEFAULT '0' COMMENT '点击次数',
  `share_count` int DEFAULT '0' COMMENT '分享次数',

  -- 系统字段
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_app_promotion` (`appstore_app_id`, `start_time`),
  KEY `idx_app_id` (`app_id`),
  KEY `idx_start_time` (`start_time`),
  KEY `idx_status_start` (`status`, `start_time` DESC),
  KEY `idx_featured_hot` (`is_featured`, `is_hot`, `priority_score` DESC),
  KEY `idx_discovery` (`discovered_at` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='限免推广记录表';
```

### 3. 应用分类表 (categories)

**表说明**: 存储App Store官方分类信息，支持筛选功能

```sql
CREATE TABLE `categories` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `category_id` varchar(20) NOT NULL COMMENT 'App Store分类ID',
  `parent_id` varchar(20) DEFAULT NULL COMMENT '父分类ID',
  `name_cn` varchar(100) NOT NULL COMMENT '中文名称',
  `name_en` varchar(100) NOT NULL COMMENT '英文名称',
  `category_type` varchar(20) NOT NULL COMMENT '分类类型: GAME=游戏, APP=应用',
  `icon_url` varchar(500) DEFAULT NULL COMMENT '分类图标URL',
  `sort_order` int DEFAULT '0' COMMENT '排序权重',
  `is_active` tinyint(1) DEFAULT '1' COMMENT '是否启用',
  `description` text COMMENT '分类描述',

  -- 统计信息
  `app_count` int DEFAULT '0' COMMENT '应用总数',
  `free_app_count` int DEFAULT '0' COMMENT '当前限免应用数',
  `avg_rating` decimal(3,2) DEFAULT NULL COMMENT '平均评分',

  -- 系统字段
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_category_id` (`category_id`),
  KEY `idx_parent` (`parent_id`),
  KEY `idx_type_order` (`category_type`, `sort_order`),
  KEY `idx_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='应用分类表';
```

### 4. 价格历史表 (price_history)

**表说明**: 记录应用价格变化历史，支持价格趋势图展示

```sql
CREATE TABLE `price_history` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `app_id` varchar(32) NOT NULL COMMENT '应用ID(关联apps表)',
  `appstore_app_id` varchar(20) NOT NULL COMMENT 'App Store应用ID',

  -- 价格信息
  `price` decimal(10,2) NOT NULL COMMENT '价格',
  `currency` varchar(10) DEFAULT 'CNY' COMMENT '货币类型',
  `price_change_type` varchar(20) DEFAULT NULL COMMENT '价格变化类型: INCREASE=上涨, DECREASE=下降, FREE=限免, NORMAL=正常',
  `change_amount` decimal(10,2) DEFAULT NULL COMMENT '变化金额',
  `change_percentage` decimal(5,2) DEFAULT NULL COMMENT '变化百分比',

  -- 时间信息
  `record_date` date NOT NULL COMMENT '记录日期',
  `record_time` datetime NOT NULL COMMENT '记录时间',

  -- 关联信息
  `promotion_id` varchar(32) DEFAULT NULL COMMENT '关联的限免记录ID',
  `previous_price` decimal(10,2) DEFAULT NULL COMMENT '上一次价格',

  -- 数据来源
  `data_source` varchar(50) DEFAULT 'AUTO' COMMENT '数据来源: AUTO=自动采集, MANUAL=手动录入',
  `crawl_session_id` varchar(32) DEFAULT NULL COMMENT '采集批次ID',

  -- 系统字段
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_app_date_time` (`appstore_app_id`, `record_date`, `record_time`),
  KEY `idx_app_id` (`app_id`),
  KEY `idx_date` (`record_date` DESC),
  KEY `idx_app_date` (`app_id`, `record_date` DESC),
  KEY `idx_promotion` (`promotion_id`),
  KEY `idx_change_type` (`price_change_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='价格历史表';
```

### 5. 搜索索引表 (search_index)

**表说明**: 为全文搜索功能提供优化的索引表

```sql
CREATE TABLE `search_index` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `app_id` varchar(32) NOT NULL COMMENT '应用ID(关联apps表)',
  `appstore_app_id` varchar(20) NOT NULL COMMENT 'App Store应用ID',

  -- 搜索字段
  `app_name` varchar(255) NOT NULL COMMENT '应用名称',
  `app_name_pinyin` varchar(500) DEFAULT NULL COMMENT '应用名称拼音',
  `developer_name` varchar(255) NOT NULL COMMENT '开发商名称',
  `developer_name_pinyin` varchar(500) DEFAULT NULL COMMENT '开发商名称拼音',
  `keywords` text COMMENT '关键词(从描述中提取)',
  `category_names` varchar(500) COMMENT '分类名称(多个用逗号分隔)',
  `description_snippet` text COMMENT '描述摘要',

  -- 权重信息
  `search_weight` int DEFAULT '1' COMMENT '搜索权重',
  `popularity_score` decimal(5,2) DEFAULT '0.00' COMMENT '热度得分',
  `quality_score` decimal(5,2) DEFAULT '0.00' COMMENT '质量得分',

  -- 统计信息
  `search_count` int DEFAULT '0' COMMENT '搜索次数',
  `click_rate` decimal(5,4) DEFAULT '0.0000' COMMENT '点击率',

  -- 系统字段
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_app_id` (`app_id`),
  KEY `idx_appstore_id` (`appstore_app_id`),
  KEY `idx_search_weight` (`search_weight` DESC),
  KEY `idx_popularity` (`popularity_score` DESC),
  FULLTEXT KEY `ft_app_name` (`app_name`, `app_name_pinyin`),
  FULLTEXT KEY `ft_developer` (`developer_name`, `developer_name_pinyin`),
  FULLTEXT KEY `ft_keywords` (`keywords`),
  FULLTEXT KEY `ft_all` (`app_name`, `developer_name`, `keywords`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='搜索索引表';
```

### 6. 搜索历史表 (search_history)

**表说明**: 记录用户搜索历史，支持搜索建议功能

```sql
CREATE TABLE `search_history` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `user_id` varchar(32) DEFAULT NULL COMMENT '用户ID(未登录用户为NULL)',
  `device_id` varchar(64) DEFAULT NULL COMMENT '设备标识符',

  -- 搜索信息
  `search_query` varchar(255) NOT NULL COMMENT '搜索关键词',
  `search_query_normalized` varchar(255) DEFAULT NULL COMMENT '标准化搜索词',
  `search_type` varchar(20) DEFAULT 'NORMAL' COMMENT '搜索类型: NORMAL=普通, VOICE=语音',
  `result_count` int DEFAULT '0' COMMENT '搜索结果数量',
  `clicked_app_id` varchar(32) DEFAULT NULL COMMENT '点击的应用ID',

  -- 系统信息
  `ip_address` varchar(45) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` varchar(500) DEFAULT NULL COMMENT '用户代理',
  `platform` varchar(50) DEFAULT NULL COMMENT '平台信息',
  `app_version` varchar(20) DEFAULT NULL COMMENT '应用版本',

  -- 时间信息
  `searched_at` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '搜索时间',

  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_device_id` (`device_id`),
  KEY `idx_search_query` (`search_query`),
  KEY `idx_searched_at` (`searched_at` DESC),
  KEY `idx_result_count` (`result_count`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='搜索历史表';
```

---

## 索引优化策略

### 核心查询场景优化

#### 1. 今日限免列表查询
```sql
-- 优化查询: 获取今日限免应用列表
SELECT a.*, p.start_time, p.end_time, p.savings_amount
FROM apps a
JOIN free_promotions p ON a.id = p.app_id
WHERE p.status = 'ACTIVE'
  AND p.start_time >= CURDATE()
ORDER BY p.is_featured DESC, p.priority_score DESC, p.discovered_at DESC;

-- 对应索引
-- free_promotions表: idx_status_start, idx_featured_hot
-- apps表: PRIMARY KEY
```

#### 2. 分类筛选查询
```sql
-- 优化查询: 按分类筛选限免应用
SELECT a.*, p.start_time, p.savings_amount
FROM apps a
JOIN free_promotions p ON a.id = p.app_id
WHERE p.status = 'ACTIVE'
  AND a.primary_category_id = '6014'
  AND a.rating >= 4.0
ORDER BY p.priority_score DESC;

-- 对应索引
-- apps表: idx_category_price, idx_rating
-- free_promotions表: idx_app_id
```

#### 3. 全文搜索查询
```sql
-- 优化查询: 搜索应用
SELECT a.*, si.search_weight
FROM apps a
JOIN search_index si ON a.id = si.app_id
WHERE MATCH(si.app_name, si.developer_name, si.keywords)
      AGAINST('游戏' IN NATURAL LANGUAGE MODE)
ORDER BY si.search_weight DESC, a.rating DESC;

-- 对应索引
-- search_index表: ft_all, idx_search_weight
```

### 数据更新优化

#### 批量插入索引
```sql
-- 创建批量插入优化的复合索引
ALTER TABLE price_history ADD INDEX idx_bulk_insert (appstore_app_id, record_date, created_at);
ALTER TABLE free_promotions ADD INDEX idx_bulk_update (appstore_app_id, status, updated_at);
```

#### 分区表设计(可选)
```sql
-- 价格历史表按日期分区(适用于大数据量场景)
ALTER TABLE price_history PARTITION BY RANGE (TO_DAYS(record_date)) (
  PARTITION p2024_01 VALUES LESS THAN (TO_DAYS('2024-02-01')),
  PARTITION p2024_02 VALUES LESS THAN (TO_DAYS('2024-03-01')),
  -- ... 其他分区
  PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

---

## 数据初始化

### 1. 应用分类数据初始化
```sql
-- 插入游戏主分类
INSERT INTO categories (id, category_id, name_cn, name_en, category_type, sort_order) VALUES
('cat_001', '6014', '游戏', 'Games', 'GAME', 1),
('cat_002', '6000', '商务', 'Business', 'APP', 2),
('cat_003', '6002', '工具', 'Utilities', 'APP', 3),
('cat_004', '6003', '旅行', 'Travel', 'APP', 4),
('cat_005', '6004', '体育', 'Sports', 'APP', 5),
('cat_006', '6005', '社交', 'Social Networking', 'APP', 6),
('cat_007', '6006', '参考', 'Reference', 'APP', 7),
('cat_008', '6007', '效率', 'Productivity', 'APP', 8),
('cat_009', '6008', '摄影与录像', 'Photo & Video', 'APP', 9),
('cat_010', '6009', '新闻', 'News', 'APP', 10);

-- 插入游戏子分类
INSERT INTO categories (id, category_id, parent_id, name_cn, name_en, category_type, sort_order) VALUES
('cat_g01', '7001', '6014', '动作游戏', 'Action', 'GAME', 1),
('cat_g02', '7002', '6014', '冒险游戏', 'Adventure', 'GAME', 2),
('cat_g03', '7003', '6014', '街机游戏', 'Arcade', 'GAME', 3),
('cat_g04', '7004', '6014', '桌面游戏', 'Board', 'GAME', 4),
('cat_g05', '7005', '6014', '卡牌游戏', 'Card', 'GAME', 5);
```

### 2. 搜索权重配置
```sql
-- 设置搜索权重规则
UPDATE search_index SET search_weight =
  CASE
    WHEN popularity_score >= 8.0 THEN 10
    WHEN popularity_score >= 6.0 THEN 8
    WHEN popularity_score >= 4.0 THEN 6
    ELSE 3
  END;
```

---

## 性能监控

### 慢查询监控
```sql
-- 开启慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;
SET GLOBAL log_queries_not_using_indexes = 'ON';
```

### 关键指标监控
- **查询响应时间**: 核心查询应在100ms内完成
- **索引使用率**: 确保所有查询都使用了合适的索引
- **存储空间增长**: 监控表大小和索引大小增长情况
- **并发连接数**: 监控数据库连接池使用情况

---

## 数据维护策略

### 数据清理规则
```sql
-- 清理3个月前的搜索历史
DELETE FROM search_history WHERE searched_at < DATE_SUB(NOW(), INTERVAL 3 MONTH);

-- 清理无效的价格历史记录
DELETE FROM price_history WHERE record_date < DATE_SUB(CURDATE(), INTERVAL 2 YEAR);

-- 清理已结束超过1个月的限免记录统计信息
UPDATE free_promotions SET view_count = 0, click_count = 0, share_count = 0
WHERE status = 'ENDED' AND actual_end_time < DATE_SUB(NOW(), INTERVAL 1 MONTH);
```

### 定期维护任务
1. **每日任务**:
   - 更新搜索索引权重
   - 统计限免应用数据
   - 清理无效数据

2. **每周任务**:
   - 重建搜索索引
   - 优化表结构
   - 备份核心数据

3. **每月任务**:
   - 分析慢查询日志
   - 清理历史数据
   - 更新索引统计信息

---

## 总结

本数据库设计针对第一期限免应用发现核心功能进行了全面优化：

### 核心优势
1. **查询性能**: 针对列表展示、搜索、筛选等核心场景进行了索引优化
2. **数据完整性**: 完善的约束和外键设计确保数据一致性
3. **扩展性**: 为后续功能扩展预留了充分的字段和表结构
4. **运维友好**: 包含完整的监控、清理和维护策略

### 支持功能
- ✅ 今日限免列表展示 - 通过free_promotions和apps表联查
- ✅ 应用详情页面 - apps表存储完整应用信息
- ✅ 应用分类筛选 - categories表和索引优化支持
- ✅ 应用搜索功能 - search_index表和全文索引支持
- ✅ 价格历史追踪 - price_history表记录价格变化
- ✅ 搜索历史管理 - search_history表支持用户搜索记录

这套数据库设计能够有效支撑第一期开发需求，同时为后续功能扩展奠定了坚实的数据基础。