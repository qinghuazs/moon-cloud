# 定时任务调度策略

## 一、任务调度时间表

| 任务名称 | 执行时间 | Cron表达式 | 说明 |
|---------|----------|------------|------|
| App队列消费 | 每天凌晨3:00 | `0 0 3 * * ?` | 消费所有分类的App URL队列 |
| 失败任务重试 | 每30分钟 | `fixedDelay = 1800000` | 重试失败的App处理任务 |
| 清理过期记录 | 每天凌晨3:00 | `0 0 3 * * ?` | 清理7天前的失败记录 |

## 二、执行策略说明

### 1. App队列消费任务
- **执行时间**：每天凌晨3:00执行一次
- **选择原因**：
  - 凌晨时段服务器负载较低
  - 避免影响白天的正常业务
  - App Store更新通常在凌晨完成
- **处理内容**：
  - 消费所有分类队列中的URL
  - 调用Express服务获取App详情
  - 将数据保存到数据库

### 2. 失败重试任务
- **执行时间**：每30分钟执行一次
- **选择原因**：
  - 及时重试失败的任务
  - 避免失败任务积压
  - 提高数据采集成功率
- **处理内容**：
  - 从失败队列获取URL
  - 检查重试次数
  - 重新加入处理队列

### 3. 过期记录清理
- **执行时间**：每天凌晨3:00
- **选择原因**：
  - 与主任务同时执行
  - 定期清理避免数据积压
  - 保持数据库性能
- **处理内容**：
  - 清理超过7天的失败记录
  - 释放数据库存储空间

## 三、手动触发机制

除了定时任务，系统还提供了手动触发接口：

### 1. 触发所有分类消费
```bash
POST /api/appstore/queue/consume
```

### 2. 触发指定分类消费
```bash
POST /api/appstore/queue/consume/{categoryId}
```

### 3. 触发失败重试
```bash
POST /api/appstore/queue/retry
```

## 四、调度优化建议

### 1. 负载均衡
- 可根据实际业务量调整执行时间
- 避免与其他重要任务冲突
- 考虑分时段执行不同分类

### 2. 动态调整
- 监控队列大小动态调整执行频率
- 队列积压时增加执行频率
- 空闲时减少执行频率

### 3. 错误处理
- 任务执行失败时发送告警
- 记录详细的执行日志
- 设置任务超时时间

## 五、Cron表达式说明

### Cron格式
```
秒 分 时 日 月 周 [年]
```

### 常用示例
- `0 0 3 * * ?` - 每天凌晨3点
- `0 */30 * * * ?` - 每30分钟
- `0 0 0/2 * * ?` - 每2小时
- `0 0 9-18 * * MON-FRI` - 工作日9点到18点每小时
- `0 0 12 ? * WED` - 每周三中午12点

### 特殊字符说明
- `*` - 匹配任意值
- `?` - 不指定值（仅用于日和周）
- `-` - 范围
- `,` - 多个值
- `/` - 增量

## 六、监控指标

### 1. 任务执行监控
- 执行开始时间
- 执行结束时间
- 处理数据量
- 成功/失败数量

### 2. 性能监控
- 任务执行耗时
- 队列处理速度
- 数据库写入速度
- Express服务响应时间

### 3. 告警规则
- 任务执行失败
- 执行时间超过阈值
- 队列积压超过阈值
- 失败率超过阈值

## 七、配置管理

### 1. 启用/禁用任务
```yaml
appstore:
  consumer:
    enabled: true  # 设置为false禁用定时任务
```

### 2. 调整执行参数
```yaml
appstore:
  consumer:
    batch-size: 10  # 批处理大小
    thread-pool-size: 5  # 线程池大小
    max-retry: 3  # 最大重试次数
```

## 八、最佳实践

1. **定期检查**：定期检查任务执行日志
2. **性能优化**：根据实际情况优化批处理大小
3. **错误处理**：完善错误处理和重试机制
4. **监控告警**：建立完善的监控告警体系
5. **文档维护**：及时更新任务调度文档